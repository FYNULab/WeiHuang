C51 COMPILER V7.06   MAIN                                                                  07/28/2012 09:30:25 PAGE 1   


C51 COMPILER V7.06, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          /***************************************************************************************************    
   2          工程名称：      18b20_1602
   3          功能描述：      18B20传感器测温，1602显示温度值。
   4          硬件连接：  用1位杜邦线将J11_7与J17_1820连接，将1602液晶接口对应插接到P4接口。
   5          维护记录：  2011-8-22
   6          ***************************************************************************************************/
   7          #include"reg51.h"
   8          #include"intrins.h"     //_nop_();延时函数用
   9          #define uchar unsigned char
  10          #define uint unsigned int
  11          
  12          sbit DQ=P2^7;    //温度控制口
  13          
  14          
  15          sbit rs=P2^5;    //命令/数据选择
  16          sbit rw=P2^4;    //读写口
  17          sbit  e=P2^3;    //锁存控制
  18          
  19          uchar data dis0[16]={'T','h','e',' ','t','e','m','p',' ','n','o','w',' ','i','s',':',};//LCD第1行
  20          uchar data dis[10]={' ',' ',' ',0x00,0x00,0x00,'.',0x00,0xeb,'C'};                     //LCD第2行
  21          //**************************************************************************************************
  22          //精确延时函数(使用12M晶振，延时T=2*t+5个指令周期,t为char型,改为int型,会加大误差）
  23          //**************************************************************************************************
  24          void delay(uint t)
  25          {
  26   1       while(--t);
  27   1      }
  28          //**************************************************************************************************
  29          //延时函数
  30          //**************************************************************************************************
  31          delay1(uint time)         //int型数据为16位,所以最大值为65535            
  32           {
  33   1        uint  i,j;             //定义变量i,j,用于循环语句 
  34   1        for(i=0;i<time;i++)    //for循环,循环50*time次
  35   1           for(j=0;j<120;j++); //for循环,循环50次
  36   1       }
  37          //**************************************************************************************************
  38          //向LCD写一命令
  39          //**************************************************************************************************
  40          wcode(uchar t)
  41          {
  42   1        rs=0;           // 写的是命令
  43   1        rw=0;           // 写状态
  44   1        e=1;            //使能
  45   1        P0=t;           //写入命令 
  46   1        delay1(20);      //等待写入,如果时间太短，会导致液晶无法显示
  47   1        e=0;            //数据的锁定
  48   1      }
  49          //**************************************************************************************************
  50          //向LCD写一数据
  51          //**************************************************************************************************
  52          wdata(uchar t)
  53          {
  54   1        rs=1;          // 写的是数据
  55   1        rw=0;          // 写状态
C51 COMPILER V7.06   MAIN                                                                  07/28/2012 09:30:25 PAGE 2   

  56   1        e=1;           //使能
  57   1        P0=t;          //写入数据
  58   1        delay1(20);     //等待写入,如果时间太短，会导致液晶无法显示
  59   1        e=0;           //数据的锁定
  60   1      }
  61          //**************************************************************************************************
  62          //LCD显示
  63          //**************************************************************************************************
  64          show()
  65          {
  66   1        uchar i;
  67   1        wcode(0x80);          //设置第一行显示地址
  68   1        for(i=0;i<16;i++)     //循环16次，写完1行
  69   1          {
  70   2            wdata(dis0[i]);   //写入该行数据
  71   2          }
  72   1      
  73   1        wcode(0xc6);          //设置第一行显示地址
  74   1        for(i=0;i<10;i++)     //循环16次，写完1行
  75   1          {
  76   2            wdata(dis[i]);   //写入该行数据
  77   2          }
  78   1      }
  79          //**************************************************************************************************
  80          //LCD 初始化
  81          //**************************************************************************************************
  82          InitLCD()
  83             {             
  84   1         wcode(0x01);   //清屏
  85   1         wcode(0x06);   //输入方式控制,增量光标不移位
  86   1         wcode(0x0e);   //显示开关控制
  87   1         wcode(0x38);   //功能设定:设置16x2显示，5x7显示,8位数据接口          
  88   1         } 
  89          //**************************************************************************************************
  90          //传感器初始化
  91          //**************************************************************************************************
  92          init_18b20()
  93          {
  94   1              uchar flag;
  95   1              DQ=1;
  96   1              delay(10);  //延时
  97   1              DQ=0;
  98   1              delay(500); //*延时，要求精度，要求大于480us*
  99   1              DQ=1;
 100   1              delay(200); //*延时，要求精度，要求大于15us*
 101   1              flag=DQ;    //DQ管脚送出60-240us的0脉冲,以示初始化成功
 102   1              delay(10);  //延时
 103   1      }
 104          //**************************************************************************************************
 105          //写一个字节函数
 106          //**************************************************************************************************
 107          write_byte(uchar t)
 108          {
 109   1       uchar i;
 110   1       for(i=0;i<8;i++)   //循环8次写入1字节
 111   1        {
 112   2          DQ=0;           //数据线置低
 113   2          delay(10);      //延时
 114   2          DQ=t&0x01;      //发送1位数据,最低位开始
 115   2          delay(50);      //*延时，要求精度*
 116   2          DQ=1;           //数据线置高
 117   2          t=t>>1;         //右移1位
C51 COMPILER V7.06   MAIN                                                                  07/28/2012 09:30:25 PAGE 3   

 118   2        }
 119   1      }
 120          //**************************************************************************************************
 121          //读一个字节函数
 122          //**************************************************************************************************
 123          uchar read_byte()
 124          {
 125   1       uchar i,value=0;;
 126   1       for(i=0;i<8;i++)   //循环8次读取1字节
 127   1        {
 128   2          value=value>>1; //右移1位
 129   2          DQ=0;           //数据线置低
 130   2          delay(10);      //延时
 131   2          DQ=1;           //数据线置高
 132   2          delay(10);      //延时
 133   2          if(DQ==1)value=value|0x80;//判断接收的1位数据是否为1
 134   2          delay(50);      //*延时，要求精度*
 135   2        }
 136   1       return(value);
 137   1      }
 138          //**************************************************************************************************
 139          //数据处理子函数
 140          //**************************************************************************************************
 141          chuli(uint temperature)
 142          {
 143   1       float t;
 144   1       if(temperature&0x8000)         //判断是否为负数
 145   1         {
 146   2           temperature=~temperature+1;//取反加1
 147   2           dis[3]=0xb0;               //显示负号
 148   2         }
 149   1       else
 150   1         {
 151   2           dis[3]=0x2b;               //显示正号 
 152   2         }
 153   1       t=temperature*0.0625+0.05;     //计算出温度值，百分位四舍五入
 154   1      
 155   1       temperature=t*10;              //本实验显示到小数点后1位,所以乘10，以便分离得到十分位
 156   1      
 157   1       dis[7]=temperature%10+0x30;    //除10取余得温度十分位，1602只识别ASCII码，+0x30目的就是把16进制转ASCII
 158   1       dis[4]=temperature/100+0x30;   //除100取整得温度十位
 159   1       dis[5]=temperature%100/10+0x30;//除100取余得十位和个位，然后除10取整得温度个位
 160   1      }
 161          //**************************************************************************************************
 162          //温度采集函数
 163          //**************************************************************************************************
 164          uint get_temp()
 165          {
 166   1          uint dat;
 167   1          uchar wenl,wenh;
 168   1          init_18b20();         //复位
 169   1          write_byte(0xcc);     //不进行编号匹配
 170   1          write_byte(0x44);     //进行温度转换
 171   1          init_18b20();         //复位   
 172   1          write_byte(0xcc);     //不进行编号匹配
 173   1          write_byte(0xbe);     //发读命令
 174   1          wenl=read_byte();     //温度低八位
 175   1          wenh=read_byte();     //温度高八位
 176   1          dat=(wenh<<8)+wenl;   //数据高低8位合并
 177   1          return(dat);          //返回测量结果
 178   1      }
 179          //**************************************************************************************************
C51 COMPILER V7.06   MAIN                                                                  07/28/2012 09:30:25 PAGE 4   

 180          //主函数
 181          //**************************************************************************************************
 182          main()
 183          {
 184   1        uint temp;
 185   1        InitLCD();             //液晶初始化
 186   1      
 187   1        while(1)               //死循环
 188   1        {  
 189   2          temp=get_temp();     //获取温度值
 190   2          chuli(temp);         //数据处理 
 191   2          show();              //显示温度值
 192   2          delay1(500);         //延时
 193   2        }
 194   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    454    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     26       7
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
