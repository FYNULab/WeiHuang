C51 COMPILER V7.06   MAIN                                                                  07/28/2012 15:59:52 PAGE 1   


C51 COMPILER V7.06, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          
   2          /***************************************************************************************************    
   3          工程名称：      RS485
   4          功能描述：      实现485双向通信,若甲板的按键按下,则通过485发送1字节数据，若乙板接收到数据正确,LED将闪烁1下。
   5          硬件连接：  用3位杜邦线分别将J9_0与J17_RO、J9_1与J17_DI以及J9_2与J17_RE连接,
   6                      用1位杜邦线将J11_0与J7_S17连接,用1位杜邦线将J10_0与J13_8连接,
   7                      将甲板和乙板RS485接口的A、B对应（即A对A，B对B）连接。
   8          维护记录：  2011-8-22
   9          ***************************************************************************************************/
  10          #include "reg51.h"       //包含头文件
  11          
  12          #define uchar unsigned char
  13          #define uint  unsigned int
  14           
  15          uchar ch;               //用于存放串口接收到的数据
  16          bit read_flag= 0 ;      //取数标志位 
  17          
  18          
  19          sbit    LED    =P0^0;   //定义LED
  20          sbit    KEY    =P2^0;   //定义按键
  21          
  22          sbit    RO     =P3^0;   //定义RO
  23          sbit    DI     =P3^1;   //定义DI
  24          sbit    RE     =P3^2;   //定义RE,用于发送接收模式选择
  25          //**************************************************************************************************
  26          //延时函数
  27          //**************************************************************************************************
  28          delay(uint time)         //int型数据为16位,所以最大值为65535            
  29           {
  30   1        uint  i,j;             //定义变量i,j,用于循环语句 
  31   1        for(i=0;i<time;i++)    //for循环,循环50*time次
  32   1           for(j=0;j<50;j++); //for循环,循环50次
  33   1       }
  34          //**************************************************************************************************
  35          //初始化串口
  36          //**************************************************************************************************
  37          void init_com( void ) 
  38          { 
  39   1        SCON = 0x50;   // 设定通信方式为方式1，允许接收，相当于REN = 1; SM1 = 1;   
  40   1        PCON = 0x00;   //SMOD=0，该语句可去掉
  41   1        IE |= 0x90 ;   //打开串口中断， 相当于 EA = 1;ES = 1;  
  42   1      
  43   1        //以下4句设置T1
  44   1        TMOD = 0x20;   // 定时器1工作于8位自动重载模式, 用于产生波特率
  45   1        TH1=0xE6;      //定时器0赋初值，TH1=(256 - (12000000 / (32 * 12 * 1200)))=230;
  46   1        TL1=0xE6;      //TL1=(256 - (12000000 / (32 * 12 * 1200)))=230;
  47   1        TR1 = 1;       //启动T1
  48   1      } 
  49          //**************************************************************************************************
  50          //串口中断函数
  51          //**************************************************************************************************
  52          void serial () interrupt 4 using 3 
  53          
  54          { 
  55   1          if (RI) 
C51 COMPILER V7.06   MAIN                                                                  07/28/2012 15:59:52 PAGE 2   

  56   1             {  
  57   2              RI = 0 ;       //此步必不可少,因为硬件不能将其置0   
  58   2              ch=SBUF;       //从SBUF中取出数据       
  59   2              read_flag= 1 ; //就置位取数标志 
  60   2              }
  61   1      
  62   1      } 
  63          //**************************************************************************************************
  64          //串口发送函数
  65          //**************************************************************************************************
  66          void send_char( unsigned char ch1) 
  67          
  68                   { 
  69   1                  SBUF=ch1;       //将待发数据放到SBUF 
  70   1                  while (TI== 0); //等待TI＝1（表示帧发送结束）发送
  71   1                  TI= 0 ;         //此步必不可少,因为硬件不能将其置0  
  72   1      
  73   1                } 
  74          //**************************************************************************************************
  75          //主函数
  76          //**************************************************************************************************
  77          void main(void)
  78          {
  79   1       init_com( ) ;        //初始化串口
  80   1       while(1)
  81   1       {
  82   2        if(KEY ==0 )        //判断是否有按键按下
  83   2         { 
  84   3          delay(100);       //延时消抖
  85   3          while(KEY ==0);   //等待按键释放
  86   3          RE = 1;           //设置485为发送模式
  87   3          send_char(0xaa);  //发送1字节数据
  88   3         }
  89   2      
  90   2        RE=0;               //设置485为接收模式
  91   2        if (read_flag)      //如果取数标志已置位，表示有接收到数据
  92   2          { 
  93   3            read_flag= 0 ;  //取数标志清0 
  94   3            if(ch==0xaa)    //判断485接收到的数据是否正确
  95   3             {LED=0;delay(5000);LED=1;} //如果正确，LED闪烁1下
  96   3          } 
  97   2       } 
  98   1      
  99   1      } 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    120    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
